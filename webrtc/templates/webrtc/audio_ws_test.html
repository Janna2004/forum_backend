<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>WebRTC 音视频+实时转写测试</title>
    <style>
        #video {
            width: 480px;
            height: 360px;
            background: #000;
        }
        #transcript {
            margin-top: 20px;
            font-size: 1.2em;
            color: #333;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            min-height: 40px;
        }
        .status {
            color: #1976d2;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h2>WebRTC 音视频+实时转写测试</h2>
    <div class="status">面试ID: <span id="interviewId">未创建</span></div>
    <video id="video" autoplay playsinline></video>
    <div id="current-question" style="margin-top:20px;font-weight:bold;color:#1976d2;">当前问题：无</div>
    <div id="transcript">转写内容将实时显示在这里...</div>
    <button id="createInterviewBtn">创建面试</button>
    <button id="startBtn" disabled>开始采集</button>
    <button id="stopBtn" disabled>停止采集</button>
    <button id="finishBtn" disabled>说完了</button>

    <script src="https://cdn.jsdelivr.net/npm/reconnecting-websocket/dist/reconnecting-websocket.min.js"></script>
    <script>
        let localStream = null;
        let ws = null;
        let audioContext, processor, input;
        let isRecording = false;
        let currentQuestion = '';
        let videoFrameTimer = null;
        let canStream = false;
        let currentInterviewId = null;

        const video = document.getElementById('video');
        const transcriptDiv = document.getElementById('transcript');
        const createInterviewBtn = document.getElementById('createInterviewBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const finishBtn = document.getElementById('finishBtn');
        const questionDiv = document.getElementById('current-question');
        const interviewIdSpan = document.getElementById('interviewId');

        // 新增：JWT登录逻辑
        async function loginAndGetToken() {
            try {
                const resp = await fetch('/users/login/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: 'testuser1', password: 'password123'})
                });
                if (!resp.ok) {
                    alert('登录失败');
                    return null;
                }
                const data = await resp.json();
                return data.token; // 取 token 字段
            } catch (e) {
                alert('登录请求异常');
                return null;
            }
        }

        // 新增：创建面试
        createInterviewBtn.onclick = async function() {
            const token = await loginAndGetToken();
            if (!token) return;

            try {
                const resp = await fetch('/interviews/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        position_name: '测试岗位',
                        position_type: 'backend',
                        position_description: '这是一个测试面试',
                        company_name: '测试公司'
                    })
                });

                if (!resp.ok) {
                    alert('创建面试失败');
                    return;
                }

                const data = await resp.json();
                console.log('创建面试响应:', data);  // 添加调试日志
                currentInterviewId = data.id;
                if (!currentInterviewId) {
                    alert('创建面试失败：未获取到面试ID');
                    return;
                }
                interviewIdSpan.textContent = currentInterviewId;
                startBtn.disabled = false;
                createInterviewBtn.disabled = true;
            } catch (e) {
                alert('创建面试请求异常');
            }
        };

        startBtn.onclick = async function() {
            if (!currentInterviewId) {
                alert('请先创建面试');
                return;
            }

            startBtn.disabled = true;
            stopBtn.disabled = false;
            finishBtn.disabled = false;
            transcriptDiv.textContent = "转写内容将实时显示在这里...";
            
            // 1. 先JWT登录拿token
            const token = await loginAndGetToken();
            if (!token) {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                finishBtn.disabled = true;
                return;
            }
            // 获取音视频流
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: {
                    sampleRate: 16000,
                    channelCount: 1,
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                }
            });
            video.srcObject = localStream;
            canStream = false;

            // 2. 用token拼接到ws url
            let ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
            let ws_url = ws_scheme + '://' + window.location.host + '/ws/webrtc/?token=' + token;
            ws = new WebSocket(ws_url);
            ws.onopen = () => {
                console.log('WebSocket已连接，发送创建流请求，面试ID:', currentInterviewId);  // 添加调试日志
                // 先发送创建/加入流请求，带上面试ID
                ws.send(JSON.stringify({
                    type: 'create_stream',
                    title: '测试流',
                    description: 'WebRTC测试',
                    interview_id: currentInterviewId
                }));
            };
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'asr_result') {
                        let text = data.text;
                        // 如果text是JSON字符串，尝试提取所有中文
                        try {
                            const obj = typeof text === 'string' ? JSON.parse(text) : text;
                            // 递归提取所有字符串中的中文
                            function extractChinese(obj) {
                                let result = '';
                                if (typeof obj === 'string') {
                                    // 匹配所有中文
                                    result += obj.match(/[\u4e00-\u9fa5，。！？、；：""''（）《》【】]/g)?.join('') || '';
                                } else if (Array.isArray(obj)) {
                                    for (const item of obj) result += extractChinese(item);
                                } else if (typeof obj === 'object' && obj !== null) {
                                    for (const key in obj) result += extractChinese(obj[key]);
                                }
                                return result;
                            }
                            text = extractChinese(obj);
                        } catch (e) {}
                        transcriptDiv.textContent = text || '[无转写内容]';
                    } else if (data.type === 'interview_message') {
                        // 显示当前问题
                        if (data.text) {
                            currentQuestion = data.text;
                            questionDiv.textContent = '当前问题：' + currentQuestion;
                        }
                        // 收到面试消息，说明流已创建/加入，可以开始采集和推流（兼容部分后端）
                        if (!isRecording && (data.phase === 'intro' || data.phase === 'question') && canStream) {
                            isRecording = true;
                            startAudioProcessing();
                            startVideoFrameSending();
                        }
                    } else if (data.type === 'stream_created' || data.type === 'joined_stream') {
                        // 只有收到stream_created/joined_stream才允许推流
                        canStream = true;
                        if (!isRecording) {
                            isRecording = true;
                            startAudioProcessing();
                            startVideoFrameSending();
                        }
                    }
                } catch (e) {
                    // 非JSON消息忽略
                }
            };
            ws.onclose = () => {
                isRecording = false;
                canStream = false;
                stopAudioProcessing();
                stopVideoFrameSending();
                finishBtn.disabled = true;
            };
        };

        function startAudioProcessing() {
            if (!canStream) return;
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            input = audioContext.createMediaStreamSource(localStream);
            processor = audioContext.createScriptProcessor(4096, 1, 1);

            input.connect(processor);
            processor.connect(audioContext.destination);

            let resampleBuffer = [];
            let sendTimer = null;

            processor.onaudioprocess = function(e) {
                if (!isRecording) return;
                const inputData = e.inputBuffer.getChannelData(0);
                const inputSampleRate = audioContext.sampleRate;
                const targetSampleRate = 16000;
                const resampled = downsampleBuffer(inputData, inputSampleRate, targetSampleRate);
                resampleBuffer = resampleBuffer.concat(Array.from(resampled));
            };

            // 定时推送，每40ms推送1280字节
            sendTimer = setInterval(() => {
                if (!isRecording) return;
                const chunkSize = 640; // 640采样点*2字节=1280字节
                while (resampleBuffer.length >= chunkSize) {
                    const chunk = resampleBuffer.slice(0, chunkSize);
                    resampleBuffer = resampleBuffer.slice(chunkSize);
                    let pcm = new Int16Array(chunk.length);
                    for (let i = 0; i < chunk.length; i++) {
                        let s = Math.max(-1, Math.min(1, chunk[i]));
                        pcm[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    let pcmBytes = new Uint8Array(pcm.length * 2);
                    for (let i = 0; i < pcm.length; i++) {
                        pcmBytes[2 * i] = pcm[i] & 0xff;
                        pcmBytes[2 * i + 1] = (pcm[i] >> 8) & 0xff;
                    }
                    let base64String = btoa(String.fromCharCode.apply(null, pcmBytes));
                    if (ws && ws.readyState === 1) {
                        ws.send(JSON.stringify({type: 'audio_frame', audio_data: base64String}));
                    }
                }
            }, 40);

            function downsampleBuffer(buffer, sampleRate, outRate) {
                if (outRate === sampleRate) return buffer;
                const sampleRateRatio = sampleRate / outRate;
                const newLength = Math.round(buffer.length / sampleRateRatio);
                const result = new Float32Array(newLength);
                let offsetResult = 0;
                let offsetBuffer = 0;
                while (offsetResult < result.length) {
                    const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                    let accum = 0, count = 0;
                    for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                        accum += buffer[i];
                        count++;
                    }
                    result[offsetResult] = accum / count;
                    offsetResult++;
                    offsetBuffer = nextOffsetBuffer;
                }
                return result;
            }

            window._stopAudioProcessing = function() {
                if (processor) {
                    processor.disconnect();
                    processor = null;
                }
                if (input) {
                    input.disconnect();
                    input = null;
                }
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                if (sendTimer) {
                    clearInterval(sendTimer);
                    sendTimer = null;
                }
                // 发送结束信号
                if (ws && ws.readyState === 1) {
                    ws.send(JSON.stringify({type: 'audio_frame', audio_data: '', end: true}));
                }
            }
        }

        function startVideoFrameSending() {
            if (!canStream) return;
            // 每1秒发送一帧视频
            if (videoFrameTimer) clearInterval(videoFrameTimer);
            const canvas = document.createElement('canvas');
            videoFrameTimer = setInterval(() => {
                if (!isRecording || !localStream) return;
                const track = localStream.getVideoTracks()[0];
                if (!track) return;
                // 截图当前视频帧
                canvas.width = video.videoWidth || 480;
                canvas.height = video.videoHeight || 360;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(blob => {
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        const base64data = reader.result.split(',')[1];
                        if (ws && ws.readyState === 1) {
                            ws.send(JSON.stringify({type: 'video_frame', frame_data: base64data, frame_type: 'keyframe'}));
                        }
                    };
                    reader.readAsDataURL(blob);
                }, 'image/jpeg', 0.8);
            }, 1000);
        }
        function stopVideoFrameSending() {
            if (videoFrameTimer) {
                clearInterval(videoFrameTimer);
                videoFrameTimer = null;
            }
        }

        finishBtn.onclick = function() {
            // 用户点击“说完了”，请求下一个问题
            if (ws && ws.readyState === 1) {
                ws.send(JSON.stringify({type: 'request_next_question'}));
            }
        };

        stopBtn.onclick = function() {
            startBtn.disabled = false;
            stopBtn.disabled = true;
            finishBtn.disabled = true;
            if (ws) ws.close();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (typeof window._stopAudioProcessing === 'function') window._stopAudioProcessing();
            stopVideoFrameSending();
            transcriptDiv.textContent = "已停止采集";
            questionDiv.textContent = "当前问题：无";
        };
    </script>
</body>
</html>
