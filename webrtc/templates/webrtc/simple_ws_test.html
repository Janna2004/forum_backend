<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>简化WebSocket测试</title>
</head>
<body>
    <h2>简化WebSocket测试</h2>
    <div id="status">状态：等待连接</div>
    <div id="log" style="background: #f5f5f5; padding: 10px; margin: 10px 0; min-height: 200px; white-space: pre-wrap;"></div>
    <button id="simpleTestBtn">测试简单WebSocket（无认证）</button>
    <button id="testBtn">测试WebRTC WebSocket（需要认证）</button>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        async function testWebSocket() {
            try {
                document.getElementById('status').textContent = '状态：正在登录...';
                log('开始登录...');
                
                // 1. 登录获取token
                const resp = await fetch('/users/login/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: 'testuser1', password: 'password123'})
                });
                
                if (!resp.ok) {
                    throw new Error(`登录失败: ${resp.status}`);
                }
                
                const data = await resp.json();
                log(`登录成功，获取到token: ${data.token.substring(0, 20)}...`);
                
                // 2. 建立WebSocket连接
                document.getElementById('status').textContent = '状态：连接WebSocket...';
                log('开始建立WebSocket连接...');
                
                const ws_url = `ws://127.0.0.1:8000/ws/webrtc/?token=${data.token}`;
                log(`WebSocket URL: ${ws_url}`);
                
                const ws = new WebSocket(ws_url);
                
                ws.onopen = () => {
                    document.getElementById('status').textContent = '状态：WebSocket已连接';
                    log('WebSocket连接成功！');
                };
                
                ws.onmessage = (event) => {
                    log(`收到消息: ${event.data}`);
                };
                
                ws.onerror = (error) => {
                    document.getElementById('status').textContent = '状态：WebSocket错误';
                    log(`WebSocket错误: ${error}`);
                };
                
                ws.onclose = (event) => {
                    document.getElementById('status').textContent = '状态：WebSocket已关闭';
                    log(`WebSocket关闭: code=${event.code}, reason=${event.reason}`);
                };
                
            } catch (error) {
                document.getElementById('status').textContent = '状态：测试失败';
                log(`测试失败: ${error.message}`);
            }
        }

        // 测试简单WebSocket（无认证）
        function testSimpleWebSocket() {
            try {
                document.getElementById('status').textContent = '状态：连接简单WebSocket...';
                log('开始连接简单WebSocket...');
                
                const ws_url = `ws://127.0.0.1:8000/ws/simple/`;
                log(`简单WebSocket URL: ${ws_url}`);
                
                const ws = new WebSocket(ws_url);
                
                ws.onopen = () => {
                    document.getElementById('status').textContent = '状态：简单WebSocket已连接';
                    log('简单WebSocket连接成功！');
                    ws.send('Hello Simple WebSocket');
                };
                
                ws.onmessage = (event) => {
                    log(`收到简单WebSocket消息: ${event.data}`);
                };
                
                ws.onerror = (error) => {
                    document.getElementById('status').textContent = '状态：简单WebSocket错误';
                    log(`简单WebSocket错误: ${error}`);
                };
                
                ws.onclose = (event) => {
                    document.getElementById('status').textContent = '状态：简单WebSocket已关闭';
                    log(`简单WebSocket关闭: code=${event.code}, reason=${event.reason}`);
                };
                
            } catch (error) {
                document.getElementById('status').textContent = '状态：简单测试失败';
                log(`简单测试失败: ${error.message}`);
            }
        }

        document.getElementById('simpleTestBtn').onclick = testSimpleWebSocket;
        document.getElementById('testBtn').onclick = testWebSocket;
    </script>
</body>
</html> 